#!/usr/bin/env bash
# Pre-push hook - runs CI checks before pushing
# Bypass with: git push --no-verify

set -euo pipefail

echo "üîç Running pre-push CI checks..."
echo ""

# Color output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Track failures
FAILED=0

# Function to run check
run_check() {
    local name="$1"
    local cmd="$2"

    echo -e "${YELLOW}‚ñ∂ ${name}${NC}"
    if eval "$cmd" > /dev/null 2>&1; then
        echo -e "${GREEN}‚úì ${name} passed${NC}"
        return 0
    else
        echo -e "${RED}‚úó ${name} failed${NC}"
        FAILED=$((FAILED + 1))
        return 1
    fi
}

# Shellcheck (match remote CI: only fail on warnings and errors, not info/style)
if command -v shellcheck &> /dev/null; then
    run_check "Shellcheck" "shellcheck --severity=warning common/scripts/*.sh"
else
    echo -e "${YELLOW}‚ö† Shellcheck not installed - skipping${NC}"
fi

# Hadolint
if command -v hadolint &> /dev/null; then
    run_check "Hadolint (snapclient)" "hadolint --config .hadolint.yaml common/docker/snapclient/Dockerfile"
    run_check "Hadolint (metadata)" "hadolint --config .hadolint.yaml digi-plus-4k/cover-display/Dockerfile"
else
    echo -e "${YELLOW}‚ö† Hadolint not installed - skipping${NC}"
fi

# Bash syntax
run_check "Bash syntax" "bash -n common/scripts/setup.sh"

# HAT configs
run_check "HAT configs" "bash tests/test-hat-configs.sh"

# HAT count
run_check "HAT count (11)" "test \$(ls -1 common/audio-hats/*.conf | wc -l | tr -d ' ') -eq 11"

echo ""
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}‚úÖ All checks passed! Pushing...${NC}"
    exit 0
else
    echo -e "${RED}‚ùå ${FAILED} check(s) failed!${NC}"
    echo ""
    echo "Fix the issues or bypass with: git push --no-verify"
    exit 1
fi
