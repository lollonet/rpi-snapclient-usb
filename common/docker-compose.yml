# rpi-snapclient-usb Docker Compose
# Resource profiles auto-detected by setup.sh: low | medium | high

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

x-security: &default-security
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

services:
  snapclient:
    image: ghcr.io/lollonet/rpi-snapclient-usb:latest
    container_name: snapclient
    network_mode: host
    restart: unless-stopped
    devices:
      - /dev/snd:/dev/snd
    volumes:
      - /var/run/dbus:/var/run/dbus
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket
      - /etc/asound.conf:/etc/asound.conf:ro
      - ./docker/snapclient/entrypoint.sh:/entrypoint.sh:ro
    environment:
      - SNAPSERVER_HOST=${SNAPSERVER_HOST:-}
      - SNAPSERVER_PORT=${SNAPSERVER_PORT:-1704}
      - HOST_ID=${CLIENT_ID:?CLIENT_ID not set in .env}
      - SOUNDCARD=${SOUNDCARD:-default}
      - ALSA_BUFFER_TIME=${ALSA_BUFFER_TIME:-150}
      - ALSA_FRAGMENTS=${ALSA_FRAGMENTS:-4}
    # Audio requires specific capabilities instead of full privileged mode
    security_opt:
      - no-new-privileges:true
    cap_add:
      - SYS_NICE       # Real-time audio scheduling
      - IPC_LOCK       # Lock memory for low-latency audio
      - SYS_RESOURCE   # Set resource limits for audio buffers
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "pidof snapclient || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: ${SNAPCLIENT_MEM_LIMIT:-128M}
          cpus: '${SNAPCLIENT_CPU_LIMIT:-0.5}'
        reservations:
          memory: ${SNAPCLIENT_MEM_RESERVE:-64M}

  metadata-service:
    image: ghcr.io/lollonet/rpi-snapclient-usb-metadata:latest
    build: ./docker/metadata-service
    container_name: metadata-service
    restart: unless-stopped
    network_mode: host
    <<: *default-security
    read_only: true
    tmpfs:
      - /tmp:size=32M,noexec,nosuid,nodev
    environment:
      - SNAPSERVER_HOST=${SNAPSERVER_HOST:-}
      - SNAPSERVER_PORT=${SNAPSERVER_RPC_PORT:-1705}
      - CLIENT_ID=${CLIENT_ID:?CLIENT_ID not set in .env}
      - METADATA_WS_PORT=8082
    volumes:
      - ./public:/app/public
      - ./docker/metadata-service/metadata-service.py:/app/metadata-service.py:ro
    logging: *default-logging
    healthcheck:
      # Use process check - WebSocket server doesn't respond to HTTP
      test: ["CMD-SHELL", "pidof python3 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: ${METADATA_MEM_LIMIT:-128M}
          cpus: '${METADATA_CPU_LIMIT:-0.5}'
        reservations:
          memory: ${METADATA_MEM_RESERVE:-64M}

  nginx:
    image: nginx:alpine
    container_name: cover-webserver
    restart: unless-stopped
    # nginx:alpine needs CAP_CHOWN for startup, can't use full security anchor
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:size=16M,noexec,nosuid,nodev
      - /var/cache/nginx:size=32M,noexec,nosuid,nodev
      - /run:size=16M,noexec,nosuid,nodev
    ports:
      - "8080:80"
    volumes:
      - ./public:/usr/share/nginx/html:ro
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: ${NGINX_MEM_LIMIT:-64M}
          cpus: '${NGINX_CPU_LIMIT:-0.25}'
        reservations:
          memory: ${NGINX_MEM_RESERVE:-32M}

  audio-visualizer:
    image: ghcr.io/lollonet/rpi-snapclient-usb-visualizer:latest
    build: ./docker/audio-visualizer
    container_name: audio-visualizer
    restart: unless-stopped
    <<: *default-security
    cap_add:
      - SYS_NICE  # Audio priority
    devices:
      - /dev/snd:/dev/snd
    volumes:
      - ./docker/audio-visualizer/visualizer.py:/app/visualizer.py:ro
    ports:
      - "8081:8081"
    environment:
      - VISUALIZER_WS_PORT=8081
      - LOOPBACK_DEVICE=hw:Loopback,1,0
      - SAMPLE_RATE=${SAMPLE_RATE:-44100}
      - BAND_MODE=${BAND_MODE:-third-octave}
    logging: *default-logging
    healthcheck:
      # Use process check - raw TCP connect spams websocket error logs
      test: ["CMD-SHELL", "pidof python3 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      snapclient:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: ${VISUALIZER_MEM_LIMIT:-256M}
          cpus: '${VISUALIZER_CPU_LIMIT:-1.0}'
        reservations:
          memory: ${VISUALIZER_MEM_RESERVE:-128M}

  fb-display:
    image: ghcr.io/lollonet/rpi-snapclient-usb-fb-display:latest
    build: ./docker/fb-display
    container_name: fb-display
    restart: unless-stopped
    profiles:
      - framebuffer
    network_mode: host
    <<: *default-security
    devices:
      - /dev/fb0:/dev/fb0
      - /dev/input:/dev/input
    volumes:
      - ./public:/app/public:ro
      - ./docker/fb-display/fb_display.py:/app/fb_display.py:ro
      - ./docker/fb-display/logo.png:/app/logo.png:ro
      - ./docker/fb-display/snapforge-text.png:/app/snapforge-text.png:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - DISPLAY_RESOLUTION=${DISPLAY_RESOLUTION:-}
      - VISUALIZER_WS_PORT=8081
      - METADATA_WS_PORT=8082
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "pidof python3 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      metadata-service:
        condition: service_healthy
      audio-visualizer:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: ${FBDISPLAY_MEM_LIMIT:-256M}
          cpus: '${FBDISPLAY_CPU_LIMIT:-1.0}'
        reservations:
          memory: ${FBDISPLAY_MEM_RESERVE:-128M}
