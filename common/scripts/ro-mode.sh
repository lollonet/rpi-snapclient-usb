#!/usr/bin/env bash
set -euo pipefail

# ============================================
# Read-Only Mode Management Script
# ============================================
# Manages the read-only overlay filesystem.
# Uses raspi-config's built-in overlayfs support.
#
# Usage:
#   ro-mode enable   - Enable read-only mode (requires reboot)
#   ro-mode disable  - Disable read-only mode (requires reboot)
#   ro-mode status   - Check current mode
# ============================================

usage() {
    cat << 'EOF'
Usage: ro-mode <command>

Commands:
  enable   Enable read-only mode (protects SD card, requires reboot)
  disable  Disable read-only mode (allows writes, requires reboot)
  status   Check current read-only mode status

Examples:
  sudo ro-mode enable   # Enable protection, then reboot
  sudo ro-mode disable  # Disable for updates, then reboot
  ro-mode status        # Check current state (no sudo needed)
EOF
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo "Error: This command requires root privileges"
        echo "Run: sudo ro-mode $1"
        exit 1
    fi
}

get_status() {
    # Check if root is mounted as overlayfs
    # raspi-config uses overlayroot: "overlayroot on / type overlay"
    if mount | grep -q " on / type overlay"; then
        echo "enabled"
    else
        echo "disabled"
    fi
}

case "${1:-}" in
    enable)
        check_root "enable"
        echo "Enabling read-only mode..."
        raspi-config nonint do_overlayfs 0
        echo "Read-only mode enabled. Reboot to activate:"
        echo "  sudo reboot"
        ;;
    disable)
        check_root "disable"
        echo "Disabling read-only mode..."
        raspi-config nonint do_overlayfs 1
        echo "Read-only mode disabled. Reboot to activate:"
        echo "  sudo reboot"
        ;;
    status)
        status=$(get_status)
        if [[ "$status" == "enabled" ]]; then
            echo "RO mode: enabled (root filesystem is read-only)"
        else
            echo "RO mode: disabled (root filesystem is writable)"
        fi
        ;;
    -h|--help|help)
        usage
        ;;
    *)
        usage
        exit 1
        ;;
esac
