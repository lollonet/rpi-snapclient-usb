name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          track_progress: true
          include_fix_links: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ## Project context
            This is a Raspberry Pi Snapcast client with Docker containers (Python 3.13).
            Services: snapclient, audio-visualizer (FFT), fb-display (framebuffer).
            Target: single-user embedded device on a trusted LAN — not a public-facing server.

            Read CLAUDE.md at the repo root for project conventions and architecture rules.
            Violations of CLAUDE.md rules count as correctness issues.

            ## Severity levels
            Use these EXACT labels (uppercase) so automated tooling can parse them:
            - **CRITICAL** — crash, data loss, security hole (blocks merge)
            - **HIGH** — wrong behavior, silent failure (should fix before merge)
            - **MEDIUM** — CI gap, dead code, stale docs, missing test coverage
            - **LOW** — fragile pattern, minor style issue, cleanup opportunity

            ## Review instructions

            ### Step 1: Check existing feedback
            BEFORE posting any comments, run:
              gh api /repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments --jq '.[].body'
              gh api /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments --jq '.[].body'
            Read ALL existing comments. DO NOT re-report issues that were already raised in
            a previous review, even if the code still looks the same — the author may have
            addressed them in a later commit. Only flag NEW issues not covered by prior comments.

            ### Step 2: Review the changes
            Use `gh pr diff` to see the current diff. Read the actual source files with `Read`
            to understand context around changed lines. Check the full commit history with
            `git log --oneline origin/main..HEAD` to understand the progression of fixes.

            ### Step 3: What to check
            Report issues in these categories (in order of priority):
            1. **Correctness bugs** — code that will produce wrong results or crash
            2. **Security vulnerabilities** — injection, SSRF, path traversal (but remember:
               this runs on a trusted LAN, not the public internet)
            3. **Data loss or corruption** — race conditions that lose data
            4. **CI/test gaps** — new code without tests, tests not wired into CI
            5. **Stale comments or docs** — comments that contradict the code they describe
            6. **Dead code** — unused functions, unreachable branches, orphaned constants

            DO NOT report:
            - Style preferences or code organization opinions
            - Theoretical issues that require an attacker to control the local MPD server
            - "Consider adding..." suggestions without a concrete problem
            - Issues already mitigated elsewhere (e.g. socket timeout covers recv loops)

            ### Step 4: Test coverage check
            If the PR adds or modifies logic in `common/docker/`, verify that either:
            - Existing tests in `tests/` cover the change, OR
            - The change is hardware-only (ALSA, framebuffer writes) and untestable in CI
            Flag missing coverage as MEDIUM.

            ### Step 5: Post feedback
            Post ONE summary comment via `gh pr comment` with a concise table:
            | Severity | File:Line | Issue |
            Use CRITICAL, HIGH, MEDIUM, LOW labels exactly as defined above.
            Use inline comments only for bugs with a concrete fix suggestion.
            If there are no actionable issues, post: "No issues found."

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api:*),Bash(git log:*),Read,Glob,Grep"
