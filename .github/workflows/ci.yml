name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          if ! command -v shellcheck &>/dev/null; then
            SC_VERSION="v0.10.0"
            curl -Lso /tmp/sc.tar.xz \
              "https://github.com/koalaman/shellcheck/releases/download/${SC_VERSION}/shellcheck-${SC_VERSION}.linux.x86_64.tar.xz"
            tar -xf /tmp/sc.tar.xz -C /tmp
            sudo install /tmp/shellcheck-${SC_VERSION}/shellcheck /usr/local/bin/
            rm -rf /tmp/sc.tar.xz /tmp/shellcheck-${SC_VERSION}
          fi
          shellcheck --version

      - name: Shellcheck
        run: |
          find common/scripts common/docker tests scripts -name '*.sh' -type f 2>/dev/null \
            | xargs -r shellcheck --severity=warning

      - name: Install hadolint
        run: |
          if ! command -v hadolint &>/dev/null; then
            HL_VERSION="v2.12.0"
            curl -Lso /tmp/hadolint \
              "https://github.com/hadolint/hadolint/releases/download/${HL_VERSION}/hadolint-Linux-x86_64"
            sudo install /tmp/hadolint /usr/local/bin/
            rm -f /tmp/hadolint
          fi
          hadolint --version

      - name: Hadolint (snapclient)
        run: hadolint --config .hadolint.yaml --failure-threshold warning common/docker/snapclient/Dockerfile

      - name: Hadolint (metadata-service)
        run: hadolint --config .hadolint.yaml --failure-threshold warning common/docker/metadata-service/Dockerfile

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install test dependencies
        run: pip install pytest numpy Pillow requests websockets

      - name: Run Python tests
        run: pytest tests/ -v --tb=short

      - name: Bash syntax check (setup.sh)
        run: bash -n common/scripts/setup.sh

      - name: Test HAT configurations
        run: bash tests/test-hat-configs.sh

      - name: Test entrypoint validation
        run: bash tests/test-entrypoint.sh

      - name: Validate HAT config count
        run: |
          count=$(ls -1 common/audio-hats/*.conf | wc -l)
          if [ "$count" -ne 11 ]; then
            echo "Expected 11 HAT configs, found $count"
            exit 1
          fi
          echo "All 11 HAT configs present"
